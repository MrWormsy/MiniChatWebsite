<style>
    #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }

    #messages li {
        padding: 5px 10px;
    }

    #messages li:nth-child(odd) {
        background: #eee;
    }

</style>

<div class="container">



    <section class="section">

        <div class="tile is-ancestor">
            <div class="tile is-parent" id="chart_box">
                <div class="tile is-child box">
                    <ul id="messages"></ul>
                </div>
            </div>
        </div>


    </section>

    <div class="field is-grouped">
        <p class="control is-expanded">
            <input id="m" autocomplete="off" class="input is-fullwidth" type="text" placeholder="Message">
        </p>
        <p class="control">
            <a id="sendButton" class="button is-primary is-fullwidth">
                <span class="icon"><i class="fas fa-paper-plane"></i></span>
                <span>Send</span>
            </a>
        </p>
    </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
    const conversationId = "<%=conversationid%>";
    const senderId = "<%=session.userid%>";
    const username = "<%=session.username%>";

    // The socket variable
    const socket = io('/conversations');

    socket.emit('choose conversation', {conversationId: conversationId, userId: senderId, username: username});

    function emitMessage(message) {

        // Format the message to suit the database
        let messageToSend = {timestamp: Date.now(), conversationId: conversationId, senderId: senderId, username: username, content: message};

        // Emit from this socket to the server and the server will do the rest
        socket.emit('chat message', messageToSend);
    }

    $(function () {

        // When the user press enter on the message input we send it
        $('#m').keyup(function (e) {
            if (e.keyCode == 13) {
                $('#sendButton').click();
            }
        });

        // When we click the button
        $('#sendButton').click(function (e) {
            e.preventDefault(); // prevents page reloading

            // We check that the message is not empty
            if ($('#m').val() === '') {
                return;
            }

            emitMessage($('#m').val());

            $('#m').val('');
            return false;
        });

        // When the socket receives the 'chat message event'
        socket.on('chat message', function (msg) {
            $('#messages').append($('<li>').text(msg.username + ": " + msg.content));
        });

        // When a user join the chat
        socket.on('user joined', function (message) {
            $('#messages').append($('<li>').text(message + " has joined the chat"));
        })

        // When a user join the chat
        socket.on('user quit', function (message) {
            $('#messages').append($('<li>').text(message + " has quit the chat"));
        })

        // When we want to update the list of online users
        // TODO ISSUE HERE, THIS DO NOT TRIGGERS
        socket.on('users online', function (message) {
            console.log(message);
        })
    });
</script>


